# Circle CI configuration file
# https://circleci.com/docs/

version: 2


###########################################
# Define some common steps as YAML anchors.
#

apt-run:  &apt-install
  name: Install apt packages
  command: |
    sudo apt-get -qq update
    sudo apt-get install -y \
      inkscape \
      libav-tools \
      dvipng \
      pgf \
      lmodern \
      cm-super \
      texlive-latex-base \
      texlive-latex-extra \
      texlive-fonts-recommended \
      texlive-latex-recommended \
      texlive-xetex \
      graphviz \
      libgeos-dev \
      otf-freefont

conda36-run:  &conda36-install
  name: Install conda
  command: |
    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh \
      -O miniconda.sh
    chmod +x miniconda.sh && ./miniconda.sh -b -p $HOME/miniconda
    export PATH="$HOME/miniconda/bin:$PATH"
    echo $PATH
    conda update --yes --quiet conda

    # Configure the conda environment and put it in the path using the
    # provided versions
    conda create -n testenv --yes --quiet python
    source activate testenv

conda27-run:  &conda27-install
  name: Install conda
  command: |
    wget https://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh \
      -O miniconda.sh
    chmod +x miniconda.sh && ./miniconda.sh -b -p $HOME/miniconda
    export PATH="$HOME/miniconda/bin:$PATH"
    conda update --yes --quiet conda

    # Configure the conda environment and put it in the path using the
    # provided versions
    conda create -n testenv --yes --quiet python
    source activate testenv

fonts-run:  &fonts-install
  name: Install custom fonts
  # We manually install Humor-Sans using the package from Ubuntu 14.10.
  # Unfortunately humor sans is not available in the Ubuntu version used by
  # CircleCI but we can manually install the deb from a later version since
  # it is basically just a .ttf file.
  command: |
    mkdir -p ~/.local/share/fonts
    wget -nc https://github.com/google/fonts/blob/master/ofl/felipa/Felipa-Regular.ttf?raw=true -O ~/.local/share/fonts/Felipa-Regular.ttf || true
    if [ ! -f ~/.local/share/fonts/Humor-Sans.ttf ]; then
      wget https://mirrors.kernel.org/ubuntu/pool/universe/f/fonts-humor-sans/fonts-humor-sans_1.0-1_all.deb
      mkdir tmp
      dpkg -x fonts-humor-sans_1.0-1_all.deb tmp
      cp tmp/usr/share/fonts/truetype/humor-sans/Humor-Sans.ttf ~/.local/share/fonts
      rm -rf tmp
    else
      echo "Not downloading Humor-Sans; file already exists."
    fi
    fc-cache -f -v

pip-run:  &pip-install
  # Upgrade pip and setuptools and wheel to get as clean an install as possible
  name: Upgrade pip, setuptools, wheel
  command: |
    export PATH="$HOME/miniconda/bin:$PATH"
    source activate testenv
    pip install --upgrade pip
    pip install --upgrade wheel
    pip install --upgrade setuptools

deps-run: &deps-install
  name: Install Python dependencies
  command: |
    export PATH="$HOME/miniconda/bin:$PATH"
    source activate testenv
    pip install numpy${NUMPY_VERSION} codecov coverage
    pip install -r doc-requirements.txt

mpl-run: &mpl-install
  name: Install Matplotlib
  command: |
    export PATH="$HOME/miniconda/bin:$PATH"
    source activate testenv
    pip install -ve .

linkchecker-run: &linkchecker-install
  name: Install linkchecker
  command: |
    export PATH="$HOME/miniconda/bin:$PATH"
    source activate testenv
    pip install $PRE requests==2.9.2 linkchecker

doc-run: &doc-build
  name: Build documentation
  command: |
    export PATH="$HOME/miniconda/bin:$PATH"
    source activate testenv
    make
  working_directory: doc

doc-bundle-run: &doc-bundle
  name: Bundle sphinx-gallery documentation artifacts
  command: tar cf doc/build/sphinx-gallery-files.tar.gz doc/api/_as_gen doc/gallery doc/tutorials
  when: always


##########################################
# Here is where the real jobs are defined.
#

jobs:
  docs-python36:
    docker:
      - image: circleci/python:3.6
    steps:
      - checkout

      - run: *apt-install
      - run: *conda36-install
      - run: *fonts-install
      - run: *pip-install

      - run: *deps-install
      - run: *mpl-install

      - run: *doc-build

      - run: *doc-bundle
      - store_artifacts:
          path: doc/build/sphinx-gallery-files.tar.gz

      - store_artifacts:
          path: doc/build/html

      - run:
          name: "Built documentation is available at:"
          command: echo "${CIRCLE_BUILD_URL}/artifacts/${CIRCLE_NODE_INDEX}/${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}/doc/build/html/index.html"

      - add_ssh_keys:
          fingerprints:
            - "78:13:59:08:61:a9:e5:09:af:df:3a:d8:89:c2:84:c0"
      - deploy:
          name: "Deploy new docs"
          command: ./.circleci/deploy-docs.sh

  docs-python27:
    docker:
      - image: circleci/python:2.7
    steps:
      - checkout

      - run: *apt-install
      - run: *conda27-install
      - run: *fonts-install
      - run: *pip-install

      - run:
          <<: *deps-install
          environment:
            NUMPY_VERSION: "==1.7.1"
      # Linkchecker only works with python 2.7 for the time being.
      # Linkchecker is currently broken with requests 2.10.0 so force an earlier version.
      - run: *linkchecker-install
      - run: *mpl-install

      - run: *doc-build

      # We don't build the LaTeX docs here, so linkchecker will complain
      - run: touch doc/build/html/Matplotlib.pdf

      # Linkchecker only works with python 2.7 for the time being
      - run:
          name: linkchecker
          command: ~/.local/bin/linkchecker build/html/index.html
          working_directory: doc

      - run: *doc-bundle
      - store_artifacts:
          path: doc/build/sphinx-gallery-files.tar.gz

      - store_artifacts:
          path: doc/build/html

      - run:
          name: "Built documentation is available at:"
          command: echo "${CIRCLE_BUILD_URL}/artifacts/${CIRCLE_NODE_INDEX}/${CIRCLE_WORKING_DIRECTORY/#\~/$HOME}/doc/build/html/index.html"


#########################################
# Defining workflows gets us parallelism.
#

workflows:
  version: 2
  build:
    jobs:
      - docs-python36
      - docs-python27
